package com.feng.webmagic.PageProcess;

import static org.assertj.core.api.Assertions.allOf;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.feng.dao.SligerDao;
import com.feng.entity.Singer;

import lombok.extern.slf4j.Slf4j;
import us.codecraft.webmagic.Page;
import us.codecraft.webmagic.Request;
import us.codecraft.webmagic.Site;
import us.codecraft.webmagic.Spider;
import us.codecraft.webmagic.processor.PageProcessor;

@Slf4j
@Component
public class MusicPageProcessor implements PageProcessor {
	
	 @Autowired
	 private MusictextProcessTwo musictextProcessTwo;
	 
	 @Autowired
	 private SligerDao sligerDao;

	private Site site = Site.me().setRetryTimes(3).setSleepTime(100)
			.setUserAgent(
					"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_2) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.65 Safari/537.31");
	;

	@Override
	public void process(Page page) {
    List<String> url=  page.getHtml().links().regex("https://music\\.163\\.com/song\\?id\\=\\d+").all();
    
     String url111 = page.getUrl().toString();
     List<Singer> singers =     sligerDao. findByUrl(url111);
     Long singerId = singers.get(0).getId();
     String singerIdString= String.valueOf(singerId);
    for (int i = 0;i< url.size();i++) {
    	Request request =new Request();
    	request.addCookie("singerId", singerIdString);
    	Spider.create(musictextProcessTwo).addUrl(url.get(i)).thread(1).addRequest(request).run();
	}
    
         
    
    
    System.out.println("jjjj");
	}

	@Override
	public Site getSite() {
		// TODO Auto-generated stub
		return site;
	}

}
